function qFactory(e,t){function s(e,t,n){var o;if(e){if(r(e)){for(o in e){if(o!="prototype"&&o!="length"&&o!="name"&&(!e.hasOwnProperty||e.hasOwnProperty(o))){t.call(n,e[o],o)}}}else if(e.forEach&&e.forEach!==s){e.forEach(t,n)}else if(i(e)){for(o=0;o<e.length;o++)t.call(n,e[o],o)}else{for(o in e){if(e.hasOwnProperty(o)){t.call(n,e[o],o)}}}}return e}function c(e){return e}function h(e){return a(e)}function p(e){var t=o(),n=0,r=i(e)?[]:{};s(e,function(e,i){n++;u(e).then(function(e){if(r.hasOwnProperty(i))return;r[i]=e;if(!--n)t.resolve(r)},function(e){if(r.hasOwnProperty(i))return;t.reject(e)},function(e){if(r.hasOwnProperty(i))return;t.notify(e)})});if(n===0){t.resolve(r)}return t.promise}var n={}.toString;var r=function(t){return typeof t=="function"};var i=function(t){return n.call(t)==="[object Array]"};var o=function(){var n=[],i,s;s={resolve:function(t){if(n){var r=n;n=undefined;i=u(t);if(r.length){e(function(){var e;for(var t=0,n=r.length;t<n;t++){e=r[t];i.then(e[0],e[1],e[2])}})}}},reject:function(e){s.resolve(f(e))},notify:function(t){if(n){var r=n;if(n.length){e(function(){var e;for(var n=0,i=r.length;n<i;n++){e=r[n];e[2](t)}})}}},promise:{then:function(e,s,u){var a=o();var f=function(n){try{a.resolve((r(e)?e:c)(n))}catch(i){a.reject(i);t(i)}};var l=function(e){try{a.resolve((r(s)?s:h)(e))}catch(n){a.reject(n);t(n)}};var p=function(e){try{a.notify((r(u)?u:c)(e))}catch(n){t(n)}};if(n){n.push([f,l,p])}else{i.then(f,l,p)}return a.promise},"catch":function(e){return this.then(null,e)},"finally":function(e){function t(e,t){var n=o();if(t){n.resolve(e)}else{n.reject(e)}return n.promise}function n(n,i){var s=null;try{s=(e||c)()}catch(o){return t(o,false)}if(s&&r(s.then)){return s.then(function(){return t(n,i)},function(e){return t(e,false)})}else{return t(n,i)}}return this.then(function(e){return n(e,true)},function(e){return n(e,false)})}}};return s};var u=function(t){if(t&&r(t.then))return t;return{then:function(n){var r=o();e(function(){r.resolve(n(t))});return r.promise}}};var a=function(e){var t=o();t.reject(e);return t.promise};var f=function(n){return{then:function(i,s){var u=o();e(function(){try{u.resolve((r(s)?s:h)(n))}catch(e){u.reject(e);t(e)}});return u.promise}}};var l=function(n,i,s,f){var l=o(),p;var d=function(e){try{return(r(i)?i:c)(e)}catch(n){t(n);return a(n)}};var v=function(e){try{return(r(s)?s:h)(e)}catch(n){t(n);return a(n)}};var m=function(e){try{return(r(f)?f:c)(e)}catch(n){t(n)}};e(function(){u(n).then(function(e){if(p)return;p=true;l.resolve(u(e).then(d,v,m))},function(e){if(p)return;p=true;l.resolve(v(e))},function(e){if(p)return;l.notify(m(e))})});return l.promise};return{defer:o,reject:a,when:l,all:p}}window.q=qFactory(function(e){setTimeout(function(){e()},0)},function(e){console.error("qLite: "+e.stack)})